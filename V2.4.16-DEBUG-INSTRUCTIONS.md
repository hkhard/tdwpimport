# Version 2.4.16 - GamePlayer Field Extraction Debug

## What v2.4.15 Debug Logs Revealed

The v2.4.15 debug logs successfully narrowed down the problem:

### ✅ What's Working:
1. Players wrapper correctly identified as `New` type with constructor `GamePlayers`
2. GamePlayers wrapper successfully unwrapped
3. Inner `Players` field found with type `Call` (Map.from)
4. Map.from() successfully unwrapped to Array
5. All 15 items correctly identified as Map.from pairs (Array with 2 items)
6. Second element of each pair correctly identified as `New` type
7. GamePlayer constructor correctly detected for all 15 items
8. `extract_game_player()` method successfully called for all 15 players

### ❌ What's Failing:
**ALL 15 players return null from `extract_game_player()`**

The debug logs show this pattern for EVERY player:
```
"Item 0 extracting GamePlayer"
"Item 0 extraction returned null or empty UUID"

"Item 1 extracting GamePlayer"
"Item 1 extraction returned null or empty UUID"

... (repeats for all 15 players)
```

## Root Cause Analysis

The problem is in `extract_game_player()` at lines 363-365:

```php
if (empty($player['uuid']) || empty($player['nickname'])) {
    return null;
}
```

This check is failing for ALL players, which means:

**Possible Causes:**
1. The GamePlayer object doesn't have a field called `UUID` (maybe `Id` or `PlayerId`?)
2. The GamePlayer object doesn't have a field called `Nickname` (maybe `Name` or `PlayerName`?)
3. These fields exist but `get_scalar()` isn't extracting them correctly
4. These fields exist but contain empty/null values in the .tdt file

## What v2.4.16 Debug Version Does

v2.4.16 adds **4 critical debug log points** in `extract_game_player()`:

### 1. Log Available GamePlayer Keys
```php
Poker_Tournament_Import_Debug::log("v2.4.16 DEBUG: GamePlayer keys: " . implode(', ', array_keys($p_entries)));
```
**Purpose**: Shows ALL field names actually present in GamePlayer object
**Expected Output**: `"v2.4.16 DEBUG: GamePlayer keys: UUID, Nickname, Buyins, HitsAdjustment, ..."`

### 2. Log Extracted UUID Value
```php
Poker_Tournament_Import_Debug::log("v2.4.16 DEBUG: Extracted UUID: " . var_export($uuid, true));
```
**Purpose**: Shows exactly what value get_scalar() returns for UUID field
**Possible Outputs**:
- `"NULL"` - Field doesn't exist
- `"''"` - Field exists but is empty string
- `"'116a21f0-...'"` - Field exists with actual UUID value

### 3. Log Extracted Nickname Value
```php
Poker_Tournament_Import_Debug::log("v2.4.16 DEBUG: Extracted Nickname: " . var_export($nickname, true));
```
**Purpose**: Shows exactly what value get_scalar() returns for Nickname field
**Possible Outputs**:
- `"NULL"` - Field doesn't exist
- `"''"` - Field exists but is empty string
- `"'Joakim H'"` - Field exists with actual player name

### 4. Log Null Return Reason
```php
Poker_Tournament_Import_Debug::log("v2.4.16 DEBUG: Returning null - UUID or Nickname is empty");
```
**Purpose**: Confirms the method is hitting the empty check and returning null

## Expected Debug Output

For each player, you should see:

```
v2.4.16 DEBUG: GamePlayer keys: UUID, Nickname, Buyins, HitsAdjustment
v2.4.16 DEBUG: Extracted UUID: '116a21f0-...'
v2.4.16 DEBUG: Extracted Nickname: 'Joakim H'
```

OR if fields are named differently:

```
v2.4.16 DEBUG: GamePlayer keys: Id, Name, Buyins, Hits
v2.4.16 DEBUG: Extracted UUID: NULL
v2.4.16 DEBUG: Extracted Nickname: NULL
v2.4.16 DEBUG: Returning null - UUID or Nickname is empty
```

## Installation Instructions

### Step 1: Install v2.4.16
1. Go to WordPress Admin → Plugins
2. Deactivate "Poker Tournament Import"
3. Delete the old version
4. Upload `poker-tournament-import-v2.4.16.zip`
5. Activate the plugin

### Step 2: Re-Import the File
1. Go to the import interface
2. Upload `ORF_Poker_20250213.tdt`
3. Complete the import

### Step 3: Check Debug Logs
Look for lines starting with:
- `v2.4.16 DEBUG: GamePlayer keys:`
- `v2.4.16 DEBUG: Extracted UUID:`
- `v2.4.16 DEBUG: Extracted Nickname:`
- `v2.4.16 DEBUG: Returning null -`

### Step 4: Share Debug Output
Copy the v2.4.16 debug lines for **at least the first 2-3 players** (we don't need all 15, the first few will show the pattern).

## What We'll Learn

The v2.4.16 debug output will definitively answer:

1. **Are the field names correct?**
   - If keys show "UUID" and "Nickname" → Field names are correct
   - If keys show different names → We need to update the code to use actual field names

2. **Is get_scalar() working?**
   - If UUID shows a value like `'116a21f0-...'` → get_scalar() works
   - If UUID shows NULL when keys include "UUID" → get_scalar() has a bug

3. **Are the values actually present?**
   - If fields exist and contain values → The problem is elsewhere
   - If fields exist but are empty → The .tdt file might not have this data

## Likely Scenarios and Solutions

### Scenario 1: Different Field Names
**If debug shows**: `GamePlayer keys: Id, Name, Buyins, ...`
**Solution**: Update line 357-358 to use correct field names:
```php
$uuid = $this->get_scalar($p_entries, 'Id');  // Changed from 'UUID'
$nickname = $this->get_scalar($p_entries, 'Name');  // Changed from 'Nickname'
```

### Scenario 2: get_scalar() Not Extracting Strings
**If debug shows**: UUID is NULL when "UUID" exists in keys
**Solution**: Check get_scalar() method - might have a bug with String node extraction

### Scenario 3: Empty Values in File
**If debug shows**: UUID is empty string `''`
**Solution**: Values might need to come from a different field or structure

## Files Created

- `poker-tournament-import-v2.4.16.zip` - Installation package
- `V2.4.16-DEBUG-INSTRUCTIONS.md` - This document
- Updated version numbers in all files
- Added changelog and upgrade notice

## Technical Details

**Modified File**: `includes/class-tdt-domain-mapper.php`
**Modified Method**: `extract_game_player()` (lines 350-376)
**Debug Logs Added**: 4 log points
**Log Prefix**: "v2.4.16 DEBUG:"

---

**Ready for testing!** Install v2.4.16, import the file, and share the GamePlayer debug output.
