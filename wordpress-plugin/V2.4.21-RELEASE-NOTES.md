# Version 2.4.21 - Formula Editor Backslash Escaping Fix

## Release Date
October 16, 2025

## Type
**Formula Editor Fix** - Removes unwanted backslash escaping in Formula Manager

## Summary

Version 2.4.21 fixes the Formula Manager to prevent unwanted backslash escaping when saving formulas containing quotes. Previously, WordPress magic quotes would automatically escape quotes in $_POST data, causing formulas like `assign("nSafe", max(n, 1))` to save as `assign(\"nSafe\", max(n, 1))` with backslash-escaped quotes. This version adds `wp_unslash()` wrapper before sanitization to remove the automatic escaping while maintaining security.

## The Problem

### Symptom: Backslashes Added to Saved Formulas

When users tried to save formulas with quotes in Formula Manager:
1. Enter formula: `assign("nSafe", max(n, 1))`
2. Click "Save Formula" → Success message appears
3. Reload page → Formula displays as: `assign(\"nSafe\", max(n, 1))` with backslashes

### Root Cause: WordPress Magic Quotes Double-Escaping

```php
// WRONG (v2.4.20 and earlier)
public function ajax_save_formula() {
    // WordPress magic quotes automatically escape $_POST data
    // Then sanitize_textarea_field() may add additional escaping
    'formula' => sanitize_textarea_field($_POST['formula']),  // ❌ Double-escaping
    'dependencies' => sanitize_textarea_field($_POST['dependencies']),  // ❌ Double-escaping
}
```

**Impact**: WordPress's automatic slashing of $_POST data combined with sanitization functions caused quotes to be escaped, making formulas display with unwanted backslashes.

## The Solution

### Add wp_unslash() Before Sanitization

```php
// CORRECT (v2.4.21)
public function ajax_save_formula() {
    // wp_unslash() removes WordPress magic quotes BEFORE sanitization
    'formula' => sanitize_textarea_field(wp_unslash($_POST['formula'])),  // ✅ Clean save
    'dependencies' => sanitize_textarea_field(wp_unslash($_POST['dependencies'])),  // ✅ Clean save
}
```

### How This Works

1. **WordPress adds slashes**: Automatic magic quotes on $_POST data
2. **wp_unslash() removes slashes**: Strips automatic escaping
3. **sanitize_textarea_field() cleans**: Sanitizes without double-escaping
4. **Result**: Formulas save exactly as entered

### Benefits

- ✅ Formulas save without backslash escaping
- ✅ Quotes remain unescaped in saved formulas
- ✅ Maintains security via sanitize_textarea_field()
- ✅ WordPress standard pattern for handling $_POST data
- ✅ No changes needed to formula validation or execution

## What Changed

### Files Modified

**1. `/poker-tournament-import.php`** (lines 719-720)

**Changed: Added wp_unslash() wrapper in `ajax_save_formula()` method**

```php
// Before (wrong - allows double-escaping)
$formula_data = array(
    'name' => sanitize_text_field($_POST['display_name']),
    'description' => sanitize_textarea_field($_POST['description']),
    'formula' => sanitize_textarea_field($_POST['formula']),  // ❌ Double-escaping
    'dependencies' => sanitize_textarea_field($_POST['dependencies']),  // ❌ Double-escaping
    'category' => sanitize_text_field($_POST['category'])
);

// After (correct - prevents double-escaping)
$formula_data = array(
    'name' => sanitize_text_field($_POST['display_name']),
    'description' => sanitize_textarea_field($_POST['description']),
    'formula' => sanitize_textarea_field(wp_unslash($_POST['formula'])),  // ✅ Clean save
    'dependencies' => sanitize_textarea_field(wp_unslash($_POST['dependencies'])),  // ✅ Clean save
    'category' => sanitize_text_field($_POST['category'])
);
```

**2. `/poker-tournament-import.php`**
- Updated Version from 2.4.20 to 2.4.21 (line 6)
- Updated VERSION constant to 2.4.21 (line 23)

**3. `/readme.txt`**
- Updated stable tag to 2.4.21 (line 6)
- Added v2.4.21 changelog entry (lines 78-93)
- Added v2.4.21 upgrade notice (lines 567-568)

## Installation Instructions

### Standard Update

1. **Backup your site** (always recommended)

2. **Deactivate current version**
   - WordPress Admin → Plugins
   - Deactivate "Poker Tournament Import"

3. **Delete old version**
   - Delete the deactivated plugin (ensures clean install)

4. **Install v2.4.21**
   - Upload `poker-tournament-import-v2.4.21.zip`
   - Activate the plugin

5. **Test formula saving (optional)**
   - Go to Settings → Formula Manager
   - Edit any formula
   - Add a quote: `assign("test", value)`
   - Save formula
   - Reload page → Verify no backslashes appear

### Verify Success

**Test Formula Saving**:
1. Go to Settings → Formula Manager
2. Create or edit a formula
3. Enter formula with quotes: `assign("testVar", max(n, 1))`
4. Click "Save Formula"
5. **Expected**: Reload page → formula displays as: `assign("testVar", max(n, 1))` (no backslashes)
6. **Before v2.4.21**: Formula displayed as: `assign(\"testVar\", max(n, 1))` (with backslashes)

## What This Fixes

✅ **Backslash escaping in formulas** - Quotes no longer escaped when saving formulas
✅ **Clean formula storage** - Formulas save exactly as entered in the editor
✅ **WordPress standard compliance** - Uses wp_unslash() pattern for $_POST handling
✅ **Security maintained** - Still uses sanitize_textarea_field() for safety

## What This Doesn't Change

- Formula validation logic (unchanged)
- Formula calculation engine (unchanged)
- Formula Manager UI (unchanged)
- get_formula() method (unchanged from v2.4.20)
- save_formula() method (unchanged)
- Any other plugin functionality

## Backward Compatibility

Fully backward compatible with:
- All formulas saved in previous versions
- All custom formulas
- All default formulas
- WordPress 6.0+ (same as v2.4.20)
- PHP 8.0+ (same as v2.4.20)

## Migration Path

### From v2.4.20
Direct upgrade to v2.4.21 - no special migration steps required

### After Upgrade
- Existing formulas with backslashes remain as-is (no automatic changes)
- New formula saves will not add backslashes
- Re-saving existing formulas will remove backslashes

## Use Cases

### Use Case 1: Save Formula With Quotes

**Before v2.4.21**: Formula with quotes gets backslash-escaped after save

**After v2.4.21**:
1. Enter formula: `assign("nSafe", max(n, 1))`
2. Save formula
3. Reload page → Formula displays: `assign("nSafe", max(n, 1))` (no backslashes)

### Use Case 2: Edit Existing Formula With Escaped Quotes

**Before v2.4.21**: Each save added more backslashes

**After v2.4.21**:
1. Open formula with escaped quotes: `assign(\"test\", value)`
2. Remove backslashes manually: `assign("test", value)`
3. Save formula
4. Reload page → Clean formula preserved: `assign("test", value)`

### Use Case 3: Fix v2.4.19 Typo Without Backslash Issues

**After v2.4.21**:
1. Edit tournament_points formula (enabled in v2.4.20)
2. Change `totalBuyInsAmount` → `totalBuyinsAmount`
3. Save formula
4. Formula saves cleanly without adding backslashes to existing quotes

## Known Issues

None at this time.

## Technical Details

### WordPress Magic Quotes System

WordPress automatically adds slashes to $_POST, $_GET, and $_COOKIE data for security:
- Input: `assign("test", value)`
- After magic quotes: `assign(\"test\", value)`
- Problem: Sanitization functions may preserve or add more escaping

### wp_unslash() Function

WordPress core function that removes slashes added by magic quotes:
- Input: `assign(\"test\", value)` (from $_POST)
- After wp_unslash(): `assign("test", value)`
- Then sanitized: `assign("test", value)` (no double-escaping)

### Best Practice Pattern

```php
// WordPress standard pattern for handling $_POST data
$clean_value = sanitize_textarea_field(wp_unslash($_POST['field']));
```

This pattern:
1. Removes WordPress automatic slashing
2. Applies proper sanitization
3. Prevents double-escaping
4. Maintains security

## Support

If you experience issues after installing v2.4.21:

1. **Check formula saving** - Create new formula with quotes and verify no backslashes
2. **Test existing formulas** - Re-save existing formulas to remove backslashes
3. **Verify formula execution** - Ensure formulas still calculate correctly
4. **Share debug output** - Include saved formula content in support request

## Credits

This fix was made possible by:
- User reporting unwanted backslashes appearing in saved formulas
- Analysis of WordPress magic quotes behavior in $_POST data
- Recognition that wp_unslash() is the WordPress standard solution
- Testing confirmed formulas save cleanly without escaping

---

**Version:** 2.4.21
**Release Date:** October 16, 2025
**Type:** Formula Editor Fix
**Status:** Ready for Production Use
**Upgrade Priority:** Recommended (Essential for users experiencing backslash escaping issues)
