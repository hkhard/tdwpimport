# Version 2.4.22 - TDT Import TypeError Fix

## Release Date
October 16, 2025

## Type
**CRITICAL BUGFIX** - Fixes fatal TypeError during tournament import

## Summary

Version 2.4.22 fixes a critical TypeError that occurred during TDT file imports. The error `implode(): Argument #2 ($array) must be of type ?array, string given` at line 1156 in class-parser.php was caused by formula dependencies being stored as strings in the database but the parser code expecting arrays. This version adds automatic normalization to convert string dependencies to arrays, ensuring backward compatibility with all formula storage formats.

## The Problem

### Symptom: Fatal Error During TDT Import

When users tried to import .tdt files after v2.4.21:
```
Fatal error: Uncaught TypeError: implode(): Argument #2 ($array) must be of type ?array, string given
in /wp-content/plugins/poker-tournament-import/includes/class-parser.php:1156
```

### Root Cause: Dependencies String vs Array Mismatch

```php
// PROBLEM at line 1156 in class-parser.php
if (!empty($formula_data['dependencies'])) {
    $complete_formula = implode(';', $formula_data['dependencies']) . ';';  // ❌ Expects array
}
```

**The Issue**:
- Formula Manager UI uses **textarea** for dependencies input → returns **string**
- When saved via `save_formula()`, dependencies stored as **string** in WordPress options
- Parser code at line 1156 expects dependencies to be an **array** for `implode()`
- PHP 8.0+ strict typing causes **TypeError** when string passed to `implode()`

**Impact**: All TDT imports failed with fatal error, preventing tournament data from being imported.

## The Solution

### Add Formula Data Normalization

Added `normalize_formula_data()` method in `class-formula-validator.php` to automatically convert string dependencies to arrays:

```php
// NEW METHOD (v2.4.22)
private function normalize_formula_data($formula_data) {
    if (!isset($formula_data['dependencies'])) {
        $formula_data['dependencies'] = array();
        return $formula_data;
    }

    // If dependencies is a string, convert to array
    if (is_string($formula_data['dependencies'])) {
        $deps_string = $formula_data['dependencies'];
        if (empty(trim($deps_string))) {
            $formula_data['dependencies'] = array();
        } else {
            // Split by newlines or semicolons
            $deps_array = preg_split('/[\r\n;]+/', $deps_string, -1, PREG_SPLIT_NO_EMPTY);
            $formula_data['dependencies'] = array_map('trim', $deps_array);
        }
    }

    // Ensure it's an array even if empty
    if (!is_array($formula_data['dependencies'])) {
        $formula_data['dependencies'] = array();
    }

    return $formula_data;
}
```

### Update get_formula() to Normalize

```php
// UPDATED (v2.4.22)
public function get_formula($name) {
    // Check saved custom formulas first
    $formulas = get_option('poker_tournament_formulas', array());
    if (isset($formulas[$name])) {
        return $this->normalize_formula_data($formulas[$name]);  // ✅ Normalize before returning
    }

    // Fall back to default formulas
    if (isset($this->default_formulas[$name])) {
        return $this->normalize_formula_data($this->default_formulas[$name]);  // ✅ Normalize defaults too
    }

    return null;
}
```

### How This Works

1. **Retrieval Point Normalization**: Formulas normalized when retrieved, not when saved
2. **String to Array Conversion**: Splits dependencies string by newlines (`\r\n`) or semicolons (`;`)
3. **Whitespace Trimming**: Each dependency entry trimmed for clean array values
4. **Type Safety**: Always ensures dependencies is an array before returning
5. **Backward Compatible**: Works with both string and array formats

### Benefits

- ✅ Fixes TypeError in TDT imports
- ✅ Backward compatible with existing saved formulas
- ✅ Works with both string and array dependency formats
- ✅ Flexible delimiter support (newlines or semicolons)
- ✅ Future-proof normalization at retrieval point

## What Changed

### Files Modified

**1. `/includes/class-formula-validator.php`** (lines 1582-1629)

**Changed: Updated get_formula() method**

```php
// Before (v2.4.21 and earlier)
public function get_formula($name) {
    $formulas = get_option('poker_tournament_formulas', array());
    if (isset($formulas[$name])) {
        return $formulas[$name];  // ❌ Returns dependencies as-is (might be string)
    }
    // ...
}

// After (v2.4.22)
public function get_formula($name) {
    $formulas = get_option('poker_tournament_formulas', array());
    if (isset($formulas[$name])) {
        return $this->normalize_formula_data($formulas[$name]);  // ✅ Normalizes dependencies to array
    }
    // ...
}
```

**Added: normalize_formula_data() method** (lines 1598-1629)

New private method that:
- Checks if dependencies exists and is a string
- Converts string to array by splitting on newlines or semicolons
- Trims whitespace from each dependency
- Ensures dependencies is always an array

**2. `/poker-tournament-import.php`**
- Updated Version from 2.4.21 to 2.4.22 (line 6)
- Updated VERSION constant to 2.4.22 (line 23)

**3. `/readme.txt`**
- Updated stable tag to 2.4.22 (line 6)
- Added v2.4.22 changelog entry (lines 78-93)
- Added v2.4.22 upgrade notice (lines 584-585)

## Installation Instructions

### Standard Update

1. **Backup your site** (always recommended)

2. **Deactivate current version**
   - WordPress Admin → Plugins
   - Deactivate "Poker Tournament Import"

3. **Delete old version**
   - Delete the deactivated plugin (ensures clean install)

4. **Install v2.4.22**
   - Upload `poker-tournament-import-v2.4.22.zip`
   - Activate the plugin

5. **Test TDT import**
   - Try importing a .tdt file
   - Verify no TypeError occurs
   - Check tournament data imports successfully

### Verify Success

**Test TDT Import**:
1. Go to Poker Import → Import Tournament
2. Upload a .tdt file
3. **Expected**: Import completes successfully without errors
4. **Before v2.4.22**: Fatal TypeError at class-parser.php:1156
5. **After v2.4.22**: Import works, dependencies normalized automatically

## What This Fixes

✅ **TDT import TypeError** - No more implode() fatal errors during tournament import
✅ **Formula dependencies handling** - Automatically normalizes string dependencies to arrays
✅ **Backward compatibility** - Works with formulas saved in both string and array formats
✅ **Type safety** - Ensures dependencies is always an array before use in parser

## What This Doesn't Change

- Formula storage format (unchanged - still saves as provided)
- Formula validation logic (unchanged)
- Formula calculation engine (unchanged)
- Formula Manager UI (unchanged)
- Any other plugin functionality

## Backward Compatibility

Fully backward compatible with:
- All formulas saved in v2.4.21 and earlier (string format)
- All formulas with array dependencies (if any)
- Default built-in formulas
- WordPress 6.0+ (same as v2.4.21)
- PHP 8.0+ (same as v2.4.21)

## Migration Path

### From v2.4.21
Direct upgrade to v2.4.22 - **ESSENTIAL** for all users experiencing TDT import errors

### After Upgrade
- Existing formulas continue to work
- String dependencies automatically converted to arrays on retrieval
- TDT imports work without TypeError
- No manual formula migration needed

## Technical Details

### PHP Type Safety in implode()

PHP 8.0+ enforces strict typing:
```php
implode(';', $string_var);  // ❌ TypeError in PHP 8.0+
implode(';', $array_var);   // ✅ Works correctly
```

Before v2.4.22, dependencies could be strings, causing TypeError when passed to `implode()`.

### Normalization Strategy

**Why normalize at retrieval point?**
- Doesn't modify stored data (preserves original format)
- Works with all existing formulas without migration
- Future-proof for different storage formats
- Single point of normalization for consistency

### String Splitting Pattern

```php
preg_split('/[\r\n;]+/', $deps_string, -1, PREG_SPLIT_NO_EMPTY)
```

This pattern:
- Splits on newlines (`\r\n`, `\n`) for multi-line textarea input
- Splits on semicolons (`;`) for single-line delimited input
- Filters empty entries with `PREG_SPLIT_NO_EMPTY`
- Supports mixed delimiters for flexibility

## Known Issues

None at this time.

## Support

If you experience issues after installing v2.4.22:

1. **Check TDT import** - Try importing a .tdt file and verify no TypeError
2. **Check formula dependencies** - Verify formulas with dependencies still calculate correctly
3. **Check error logs** - Look for any remaining TypeError or formula-related errors
4. **Share debug output** - Include full error message and context in support request

## Credits

This fix was made possible by:
- User reporting TypeError during TDT import after v2.4.21 upgrade
- Analysis of implode() expecting array but receiving string
- Recognition that dependencies can be stored as strings from textarea input
- Implementation of retrieval-point normalization for backward compatibility

---

**Version:** 2.4.22
**Release Date:** October 16, 2025
**Type:** Critical Bugfix
**Status:** Ready for Production Use
**Upgrade Priority:** CRITICAL (Essential for ALL users experiencing TDT import failures)
