# Version 2.4.24 - Case-Sensitive Variable Lookup Fix

## Release Date
October 16, 2025

## Type
**CRITICAL FORMULA FIX** - Fixes formula evaluation errors caused by case-sensitive variable lookup

## Summary

Version 2.4.24 fixes a critical issue where formula evaluation failed with "Insufficient operands for operator *" error due to case-sensitive variable name matching. The formula used `numberofHits` (lowercase 'o') but the Tournament Director specification variable is `numberOfHits` (uppercase 'O'). This version implements case-insensitive variable lookup, making the formula system more forgiving and preventing common typos from breaking calculations.

## The Problem

### Symptom: "Insufficient operands for operator *" Error

When formulas executed during tournament import:
```
Error: Evaluation error: Insufficient operands for operator *
```

Formula being executed:
```
assign("hits", (numberofHits * 10));
```

Tournament data provided:
```
Array (
    [total_players] => 16
    [finish_position] => 1
    [hits] => 0
    [total_buyins] => 22
    ...
)
```

### Root Cause: Case-Sensitive Variable Lookup

```php
// PROBLEM in substitute_variables() - line 1065
if ($token['type'] === 'variable' && isset($variables[$token['value']])) {
    $result[] = array('type' => 'number', 'value' => $variables[$token['value']]);
}
```

**The Issue**:
- Formula uses: `numberofHits` (lowercase 'o' in "of")
- TD specification variable is: `numberOfHits` (uppercase 'O' in "Of")
- PHP `isset()` is case-sensitive: `isset($variables['numberofHits'])` returns FALSE
- Variable token remains unsubstituted (stays as variable, not converted to number)
- When AST evaluator encounters multiplication, it finds variable token instead of number
- Error: "Insufficient operands for operator *"

**Variable Flow**:
1. Tournament data: `'hits' => 0` (internal key)
2. Mapping: `'hits' => 'numberOfHits'` creates `$variables['numberOfHits'] = 0`
3. Formula: Uses `numberofHits` (wrong casing)
4. Lookup: `isset($variables['numberofHits'])` → FALSE (case mismatch)
5. Result: Variable token not substituted, operator fails

**Impact**: All formula calculations using incorrectly-cased variable names would fail with operator errors, preventing points calculations.

## The Solution

### Implement Case-Insensitive Variable Lookup

```php
// BEFORE (v2.4.23 and earlier) - lines 1062-1072
private function substitute_variables($tokens, $variables) {
    $result = array();
    foreach ($tokens as $token) {
        if ($token['type'] === 'variable' && isset($variables[$token['value']])) {
            $result[] = array('type' => 'number', 'value' => $variables[$token['value']]);
        } else {
            $result[] = $token;
        }
    }
    return $result;
}

// AFTER (v2.4.24) - lines 1059-1085
private function substitute_variables($tokens, $variables) {
    // Create lowercase-keyed lookup map for case-insensitive matching
    $lowercase_map = array();
    foreach ($variables as $key => $value) {
        $lowercase_map[strtolower($key)] = $key;  // Map lowercase to original key
    }

    $result = array();
    foreach ($tokens as $token) {
        if ($token['type'] === 'variable') {
            $lookup_key = strtolower($token['value']);
            if (isset($lowercase_map[$lookup_key])) {
                $original_key = $lowercase_map[$lookup_key];
                $result[] = array('type' => 'number', 'value' => $variables[$original_key]);
            } else {
                $result[] = $token;  // Keep unresolved variable
            }
        } else {
            $result[] = $token;
        }
    }
    return $result;
}
```

### How This Works

1. **Create Lowercase Mapping**:
   ```php
   $lowercase_map['numberofhits'] = 'numberOfHits'
   $lowercase_map['n'] = 'n'
   $lowercase_map['r'] = 'r'
   // ... for all variables
   ```

2. **Perform Case-Insensitive Lookup**:
   ```php
   // Formula uses: numberofHits
   $lookup_key = strtolower('numberofHits')  // → 'numberofhits'
   $original_key = $lowercase_map['numberofhits']  // → 'numberOfHits'
   $value = $variables['numberOfHits']  // → 0
   ```

3. **Return Original Value**:
   - Lookup finds the correct variable regardless of casing
   - Returns value from original variables array (preserves type casting)
   - Unrecognized variables remain as tokens (for error reporting)

### Benefits

- ✅ Fixes current formula evaluation error
- ✅ Makes formula system case-insensitive and user-friendly
- ✅ Prevents typos from breaking formulas
- ✅ Allows any casing: `numberOfHits`, `numberofhits`, `NUMBEROFHITS`
- ✅ Backward compatible with correctly-cased formulas
- ✅ No performance impact (one-time map creation per calculation)

## What Changed

### Files Modified

**1. `/includes/class-formula-validator.php`** (lines 1059-1085)

**Changed: Implemented case-insensitive variable lookup in `substitute_variables()` method**

```php
// Added lowercase mapping creation
$lowercase_map = array();
foreach ($variables as $key => $value) {
    $lowercase_map[strtolower($key)] = $key;
}

// Changed lookup to use lowercase key
$lookup_key = strtolower($token['value']);
if (isset($lowercase_map[$lookup_key])) {
    $original_key = $lowercase_map[$lookup_key];
    $result[] = array('type' => 'number', 'value' => $variables[$original_key]);
}
```

**2. `/poker-tournament-import.php`**
- Updated Version from 2.4.23 to 2.4.24 (line 6)
- Updated VERSION constant to 2.4.24 (line 23)

**3. `/readme.txt`**
- Updated stable tag to 2.4.24 (line 6)
- Added v2.4.24 changelog entry (lines 78-99)
- Added v2.4.24 upgrade notice (lines 630-631)

## Installation Instructions

### Standard Update

1. **Backup your site** (always recommended)

2. **Deactivate current version**
   - WordPress Admin → Plugins
   - Deactivate "Poker Tournament Import"

3. **Delete old version**
   - Delete the deactivated plugin (ensures clean install)

4. **Install v2.4.24**
   - Upload `poker-tournament-import-v2.4.24.zip`
   - Activate the plugin

5. **Test formula evaluation (optional)**
   - Import a .tdt file
   - Verify no operator errors occur
   - Check points calculations complete successfully

### Verify Success

**Test Formula Evaluation**:
1. Import tournament with any formula
2. Check debug log or results
3. **Expected**: Formula evaluates successfully without operator errors
4. **Before v2.4.24**: "Insufficient operands for operator *" with incorrectly-cased variables
5. **After v2.4.24**: Formula works regardless of variable name casing

**Example Variable Variations (all now work)**:
- `numberOfHits` ✅ (correct TD casing)
- `numberofHits` ✅ (lowercase 'o')
- `numberofhits` ✅ (all lowercase)
- `NUMBEROFHITS` ✅ (all uppercase)
- `NumberOfHits` ✅ (Pascal case)

## What This Fixes

✅ **"Insufficient operands for operator *" error** - Formula evaluation no longer fails on case mismatches
✅ **Case-sensitive variable lookup** - Variables now match regardless of casing used in formula
✅ **Formula usability** - Users don't need to memorize exact TD variable casing
✅ **Typo tolerance** - Common casing mistakes no longer break formulas

## What This Doesn't Change

- Variable values (unchanged)
- Variable mapping (unchanged from v2.4.23)
- Formula calculation engine (unchanged)
- Formula validation logic (unchanged)
- TD specification compliance (still maintains correct internal casing)
- Any other plugin functionality

## Backward Compatibility

Fully backward compatible with:
- All formulas using correct casing (continue to work)
- All formulas using incorrect casing (now work instead of failing)
- WordPress 6.0+ (same as v2.4.23)
- PHP 8.0+ (same as v2.4.23)

## Migration Path

### From v2.4.23
Direct upgrade to v2.4.24 - **ESSENTIAL** for users experiencing operator evaluation errors

### After Upgrade
- Existing formulas with correct casing continue to work
- Formulas with casing mistakes now work instead of failing
- No manual formula changes needed
- Formula editor becomes more forgiving

## Technical Details

### PHP Case-Sensitive Array Keys

PHP array keys are case-sensitive:
```php
$array['numberOfHits'] = 0;
isset($array['numberofHits']);  // FALSE - case mismatch
isset($array['numberOfHits']);  // TRUE - exact match
```

### Lowercase Mapping Strategy

**Why map to lowercase?**
- Single normalization point for all lookups
- PHP string comparison is case-insensitive for lowercase
- Small memory overhead (one extra array per formula evaluation)
- Fast lookup performance (O(1) hash table)

**Mapping Structure**:
```php
$variables = array(
    'numberOfHits' => 0,
    'buyins' => 16,
    'rank' => 1,
    'n' => 16,
    'r' => 1
);

$lowercase_map = array(
    'numberofhits' => 'numberOfHits',  // Original key preserved
    'buyins' => 'buyins',
    'rank' => 'rank',
    'n' => 'n',
    'r' => 'r'
);
```

### Lookup Algorithm

```
1. Formula token: "numberofHits"
   ↓
2. Normalize: strtolower("numberofHits") → "numberofhits"
   ↓
3. Map lookup: $lowercase_map["numberofhits"] → "numberOfHits"
   ↓
4. Value lookup: $variables["numberOfHits"] → 0
   ↓
5. Return: array('type' => 'number', 'value' => 0)
```

### Performance Impact

- **Mapping creation**: O(n) where n = number of variables (~50-100)
- **Lookup**: O(1) hash table lookup
- **Memory**: One additional array per formula evaluation (~2-4KB)
- **Overall**: Negligible performance impact

## Use Cases

### Use Case 1: Formula with Incorrect Casing

**Before v2.4.24**: Formula fails with operator error

**After v2.4.24**:
1. Formula: `assign("hits", (numberofHits * 10))`
2. Variable: `$variables['numberOfHits'] = 0` (correct casing)
3. Lookup: `strtolower('numberofHits')` → matches → finds value
4. Result: Formula evaluates successfully, hits = 0

### Use Case 2: User Enters Formula with Typo

**Before v2.4.24**: Formula breaks, user confused why

**After v2.4.24**:
1. User types: `n * sqrt(NUMBEROFPLAYERS)`
2. Variables: `$variables['n'] = 16`, `$variables['numberofplayers'] = 16`
3. Lookup: Case-insensitive matching finds both variables
4. Result: Formula works, user doesn't realize they made casing mistake

### Use Case 3: Migrating Formula from Different System

**Before v2.4.24**: Must manually fix all variable casing

**After v2.4.24**:
1. Import formula from external system with different casing conventions
2. Case-insensitive lookup handles all variations automatically
3. No manual corrections needed
4. Formula works immediately

## Known Issues

None at this time.

## Support

If you experience issues after installing v2.4.24:

1. **Check formula evaluation** - Verify formulas execute without operator errors
2. **Check variable names** - Confirm variables are being substituted correctly
3. **Check error logs** - Look for any remaining TypeError or evaluation errors
4. **Share debug output** - Include full error message and formula in support request

## Credits

This fix was made possible by:
- User reporting "Insufficient operands for operator *" error during formula evaluation
- Analysis of formula using `numberofHits` vs TD specification `numberOfHits`
- Recognition that case-sensitive `isset()` was causing lookup failures
- Implementation of lowercase mapping table for case-insensitive matching
- Testing confirmed formulas work regardless of variable name casing

---

**Version:** 2.4.24
**Release Date:** October 16, 2025
**Type:** Critical Formula Fix
**Status:** Ready for Production Use
**Upgrade Priority:** CRITICAL (Essential for users experiencing formula operator evaluation errors)
