# Version 2.4.27 - Critical Fixes: Division by Zero and Complete Net Profit Display

## Release Date
October 16, 2025

## Type
**CRITICAL BUG FIXES** - Fixes fatal division by zero error and completes net profit display implementation

## Summary

Version 2.4.27 addresses two critical issues discovered immediately after v2.4.26 release:
1. **Fatal DivisionByZeroError** when viewing tournament detail pages
2. **Incomplete net profit display fix** - Dashboard still showing no net profit data

While v2.4.26 fixed the net profit display in `class-shortcodes.php`, it missed the statistics engine method that the dashboard actually uses. This release completes the fix and resolves a new fatal error.

## Problems Fixed

### Problem 1: Fatal DivisionByZeroError on Tournament Pages

#### Symptom
```
Fatal error: Uncaught DivisionByZeroError: Division by zero in /Users/hkh/dev/tdwpimport/wordpress-plugin/poker-tournament-import/includes/class-shortcodes.php:168
```

User reported: "there is a big error following the tournament links in the dashboard overview"

Clicking any tournament link in the dashboard caused a fatal error, making tournament detail pages completely inaccessible.

#### Root Cause

Line 168 in `class-shortcodes.php` calculated average winnings without protecting against division by zero:

```php
// PROBLEM CODE (line 168)
$average_winnings = $players_count > 0 ? $total_winnings / min($players_count, $this->get_paid_positions($tournament_uuid)) : 0;
```

**The Issue**:
- `get_paid_positions($tournament_uuid)` counts players with winnings > 0
- When no players have winnings (e.g., tournaments with no prize pool), it returns 0
- `min($players_count, 0)` evaluates to 0
- Division by 0 → Fatal DivisionByZeroError

**When This Occurs**:
- Tournaments with no prize money distributed
- Free-roll tournaments where no one cashed
- Incomplete tournament data
- Testing scenarios with mock data

#### Solution

Added safe divisor pattern to ensure divisor is always at least 1:

```php
// FIXED CODE (lines 168-170)
$paid_positions = $this->get_paid_positions($tournament_uuid);
$divisor = max(1, min($players_count, $paid_positions)); // Ensure divisor is at least 1 to prevent division by zero
$average_winnings = $players_count > 0 ? $total_winnings / $divisor : 0;
```

**Benefits**:
- ✅ Prevents division by zero in all cases
- ✅ Gracefully handles tournaments with no prize pool
- ✅ Tournament pages now load successfully
- ✅ Clear, maintainable code with inline comment explaining safety check

### Problem 2: Incomplete Net Profit Display Fix

#### Symptom

User reported: "still no total winnings displayed in any of the dashboard panels nor in the player details"

Even after v2.4.26 fix, dashboard and player cards showed no net profit data.

#### User Requirement

User explicitly stated: **"total winnings is all winnings subtracted all buy ins"**

This means NET PROFIT, not gross winnings:
- **Net Profit** = Total Winnings - Total Invested
- **Total Invested** = All buy-ins + re-entries + addons

#### Root Cause Analysis

**v2.4.26 Fix Was Incomplete**:

v2.4.26 fixed `get_top_players()` method in `class-shortcodes.php`:
```php
// v2.4.26 fixed this method (class-shortcodes.php:3966-4009)
private function get_top_players($limit = 10) {
    // Query poker_player_roi table for net_profit ✅
}
```

**BUT** the dashboard actually calls a different method:
```php
// v2.4.26 MISSED this method (class-statistics-engine.php:787-828)
public function get_player_leaderboard($limit = 10) {
    // Still querying poker_tournament_players for gross winnings ❌
}
```

**The Problem**:
1. ❌ Dashboard code calls `Statistics_Engine->get_player_leaderboard()`
2. ❌ That method was still querying `poker_tournament_players` table (gross winnings only)
3. ❌ v2.4.26 only fixed `Shortcodes->get_top_players()` which wasn't being used
4. ❌ Dashboard continued showing no net profit data

**Why This Was Missed**:
- Code duplication: Two similar methods in different classes
- Dashboard uses statistics engine method, not shortcodes method
- v2.4.26 only fixed one of the two methods

#### Solution

**Changed: Modified `get_player_leaderboard()` in Statistics Engine to query poker_player_roi table**

```php
// BEFORE (v2.4.26) - Querying wrong table
public function get_player_leaderboard($limit = 10) {
    global $wpdb;

    $leaderboard = $wpdb->get_results($wpdb->prepare(
        "SELECT
            tp.player_id,
            COUNT(*) as tournaments_played,
            SUM(tp.winnings) as total_winnings,  // ❌ Gross winnings from wrong table
            SUM(tp.points) as total_points,
            MIN(tp.finish_position) as best_finish,
            AVG(tp.finish_position) as avg_finish,
            SUM(tp.buyins) as total_buyins,
            MAX(tp.winnings) as highest_payout
         FROM {$this->players_table} tp
         GROUP BY tp.player_id
         ORDER BY total_winnings DESC, total_points DESC
         LIMIT %d",
        $limit
    ));
    // ...
}

// AFTER (v2.4.27) - Querying correct table with net profit
public function get_player_leaderboard($limit = 10) {
    global $wpdb;

    $roi_table = $wpdb->prefix . 'poker_player_roi';

    // Query poker_player_roi table for NET PROFIT (winnings - total_invested)
    $leaderboard = $wpdb->get_results($wpdb->prepare(
        "SELECT
            roi.player_id,
            COUNT(*) as tournaments_played,
            SUM(roi.net_profit) as total_winnings,  // ✅ NET PROFIT from ROI table
            SUM(tp.points) as total_points,
            MIN(tp.finish_position) as best_finish,
            AVG(tp.finish_position) as avg_finish,
            SUM(tp.buyins) as total_buyins,
            MAX(roi.total_winnings) as highest_payout,
            SUM(roi.total_invested) as total_invested,
            SUM(roi.total_winnings) as gross_winnings
         FROM {$roi_table} roi
         LEFT JOIN {$this->players_table} tp ON roi.player_id = tp.player_id AND roi.tournament_id = tp.tournament_id
         GROUP BY roi.player_id
         ORDER BY total_winnings DESC, total_points DESC
         LIMIT %d",
        $limit
    ));
    // ...
}
```

**Benefits**:
- ✅ Dashboard now shows NET PROFIT (winnings minus all investments)
- ✅ Queries correct table (poker_player_roi) with pre-calculated net_profit values
- ✅ Completes the fix started in v2.4.26
- ✅ Player cards display meaningful financial data
- ✅ Accurately reflects user's requirement

## What Changed

### Files Modified

**1. `/includes/class-shortcodes.php`** (lines 168-170)

**Changed: Added safe divisor to prevent division by zero**

- Extracted `get_paid_positions()` call to separate variable
- Wrapped divisor with `max(1, ...)` to ensure minimum value of 1
- Added inline comment explaining safety check
- Fixes DivisionByZeroError fatal crash

**2. `/includes/class-statistics-engine.php`** (lines 787-811)

**Changed: Modified `get_player_leaderboard()` to query poker_player_roi table**

- Changed query from `poker_tournament_players` to `poker_player_roi` table
- Returns `SUM(roi.net_profit)` as total_winnings
- Now displays NET PROFIT instead of gross winnings
- LEFT JOIN to poker_tournament_players to maintain points data
- Includes additional fields: total_invested, gross_winnings

**3. `/poker-tournament-import.php`**
- Updated Version from 2.4.26 to 2.4.27 (line 6)
- Updated VERSION constant to 2.4.27 (line 23)

**4. `/readme.txt`**
- Updated stable tag to 2.4.27 (line 6)
- Added v2.4.27 changelog entry
- Added v2.4.27 upgrade notice

## Installation Instructions

### Standard Update

1. **Backup your site** (always recommended)

2. **Deactivate current version**
   - WordPress Admin → Plugins
   - Deactivate "Poker Tournament Import"

3. **Delete old version**
   - Delete the deactivated plugin (ensures clean install)

4. **Install v2.4.27**
   - Upload `poker-tournament-import-v2.4.27.zip`
   - Activate the plugin

5. **Verify fixes**
   - Click tournament links in dashboard (should load without errors)
   - Check dashboard displays net profit values
   - Verify player cards show net profit data

### Verify Success

**Test 1: Tournament Pages Load**
1. Navigate to Dashboard → Tournaments
2. Click any tournament link
3. **Expected**: Tournament detail page loads successfully
4. **Before v2.4.27**: Fatal DivisionByZeroError
5. **After v2.4.27**: Page loads with full tournament details

**Test 2: Net Profit Display in Dashboard**
1. Navigate to Dashboard → Players
2. Check "Net Profit" column
3. **Expected**: Values showing profit/loss (winnings - invested)
4. **Before v2.4.27**: Empty or zero values
5. **After v2.4.27**: Shows accurate net profit calculations

**Test 3: Player Cards**
1. Click any player in dashboard
2. Check player modal "Net Profit" field
3. **Expected**: Net profit value displayed
4. **Before v2.4.27**: Missing or zero data
5. **After v2.4.27**: Accurate net profit from poker_player_roi table

## What This Fixes

✅ **Fatal DivisionByZeroError** - Tournament detail pages now handle tournaments with no prize pool
✅ **Complete net profit display** - Dashboard queries correct table (poker_player_roi) for net profit
✅ **Statistics engine fix** - Completes the net profit implementation missed in v2.4.26
✅ **Code safety** - Safe divisor pattern prevents division by zero in all cases

## What This Doesn't Change

- Net profit calculation logic (unchanged - already correct)
- poker_player_roi table structure (unchanged)
- Statistics engine ROI processing (unchanged)
- Parser winnings/total_invested calculation (unchanged)
- Any other plugin functionality

## Relationship to v2.4.26

**v2.4.26 Fixes**:
- ✅ Fixed `get_top_players()` in class-shortcodes.php to query ROI table
- ✅ Fixed tournament template to use modern AST parser
- ✅ Updated labels to "Net Profit"

**v2.4.27 Fixes** (this release):
- ✅ Fixed `get_player_leaderboard()` in class-statistics-engine.php to query ROI table (MISSED in v2.4.26)
- ✅ Fixed DivisionByZeroError in tournament display calculation (NEW issue discovered after v2.4.26)

**Why Two Releases?**
- v2.4.26 introduced a new DivisionByZeroError not present in earlier versions
- v2.4.26 only partially fixed net profit display (fixed one method, missed another)
- v2.4.27 completes the net profit fix and resolves the new fatal error

## Backward Compatibility

Fully backward compatible with:
- All existing tournament data
- All existing player statistics
- Dashboard display functionality (improved, not changed)
- WordPress 6.0+ (same as v2.4.26)
- PHP 8.0+ (same as v2.4.26)

## Migration Path

### From v2.4.26
Direct upgrade to v2.4.27 - **CRITICAL** for users experiencing:
- Fatal errors when viewing tournament pages
- Missing or zero net profit values in dashboard

### From v2.4.25 or earlier
Upgrade directly to v2.4.27 - includes all fixes from v2.4.26 plus additional critical fixes

### After Upgrade
- Tournament pages immediately accessible (no fatal errors)
- Dashboard immediately shows accurate net profit
- No manual data migration needed (poker_player_roi table already populated)
- Existing data continues to work correctly

## Technical Details

### Safe Divisor Pattern

The safe divisor pattern prevents division by zero:

```php
// Pattern: max(1, potential_zero_value)
$divisor = max(1, min($players_count, $paid_positions));
```

**How It Works**:
- `min($players_count, $paid_positions)` can return 0
- `max(1, 0)` returns 1
- `max(1, any_positive_number)` returns the positive number
- Divisor is always at least 1, preventing division by zero

**Where Used**:
- class-shortcodes.php:169 - average winnings calculation

### Data Flow for Net Profit

```
Tournament Import
      ↓
Parser calculates:
  - Winnings (gross)
  - Total Invested (buy-ins + re-entries + addons)
      ↓
Save to poker_tournament_players:
  - winnings (gross)
      ↓
Statistics Engine processes:
  - Net Profit = Winnings - Total Invested
  - ROI Percentage = (Net Profit / Total Invested) * 100
      ↓
Save to poker_player_roi:
  - total_invested
  - total_winnings (gross)
  - net_profit  ← Dashboard queries THIS
  - roi_percentage
      ↓
Dashboard calls:
  - Statistics_Engine->get_player_leaderboard() ← Fixed in v2.4.27
      ↓
Dashboard displays:
  - Net Profit from poker_player_roi table
```

### Why Two Similar Methods?

The plugin has two similar methods for player statistics:

**1. `Shortcodes->get_top_players()`** (class-shortcodes.php:3966-4009)
- Used by: Shortcode rendering for custom displays
- Fixed in: v2.4.26
- Status: ✅ Queries poker_player_roi correctly

**2. `Statistics_Engine->get_player_leaderboard()`** (class-statistics-engine.php:787-811)
- Used by: Dashboard AJAX handlers and admin displays
- Fixed in: v2.4.27 (this release)
- Status: ✅ Now queries poker_player_roi correctly

**Why This Caused Issues**:
- Code duplication between classes
- Dashboard uses statistics engine method, not shortcodes method
- v2.4.26 only fixed shortcodes method
- Dashboard continued showing no data until v2.4.27 fixed statistics engine method

## Known Issues

None at this time.

## Support

If you experience issues after installing v2.4.27:

1. **Tournament pages still crash** - Check error logs for any remaining errors
2. **Net profit values still missing** - Verify poker_player_roi table is populated (check statistics engine logs)
3. **Dashboard shows empty values** - Re-import tournaments to populate ROI table
4. **Other issues** - Include error logs and debug output in support request

## Credits

This release was made possible by:
- User reporting fatal DivisionByZeroError immediately after v2.4.26 deployment
- User clarifying that "total winnings" display was still missing after v2.4.26
- Discovery that v2.4.26 only partially fixed the net profit display issue
- Recognition that dashboard uses statistics engine method, not shortcodes method
- Implementation of safe divisor pattern to prevent division by zero

---

**Version:** 2.4.27
**Release Date:** October 16, 2025
**Type:** Critical Bug Fixes
**Status:** Ready for Production Use
**Upgrade Priority:** CRITICAL (Essential for users on v2.4.26 experiencing fatal errors or missing data)
**Upgrade from v2.4.26:** MANDATORY
